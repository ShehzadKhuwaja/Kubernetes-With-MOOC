kubectl cluster-info
kubectl config current-context
kubectl config get-contexts
kubectl config use-context <context-name>
k3d cluster list
k3d cluster create express-cluster
kubectl create deployment hashgenerator-dep --image=jakousa/dwk-app1
kubectl get deployments
kubectl get pods
kubectl logs -f express-todo-app-dep-6f8858c7fb-nn7q2
kubectl scale deployment/hashgenerator-dep --replicas=4
kubectl set image deployment/hashgenerator-dep dwk-app1=jakousa/dwk-
kubectl delete deployment hashgenerator-dep
kubectl apply -f manifests/deployment.yaml
kubectl delete -f manifests/deployment.yaml
kubectl describe deployment hashgenerator-dep
kubectl config view --minify --raw
kubectl get events
kubectl port-forward hashresponse-dep-57bcc888d7-dj5vk 3003:3000
kubectl apply -f manifests/service.yaml
k3d cluster create --port 8082:30080@agent:0 -p 8081:80@loadbalancer --agents 2
kubectl get pods -n kube-system
kubectl get svc -A
kubectl config set-context --current --namespace=<name>
kubectl delete all --all -n namespace

Kubectx -- for context switching
kubens -- for switching namespaces

-- For making path for persistent volumes on Node
docker exec -it k3d-todoapp-cluster-agent-0 mkdir -p /tmp/kube

-- Debugging commands --
kubectl get pods -o wide           
kubectl describe svc todo-app-svc
kubectl logs <pod-name>
kubectl get pvc
kubectl describe pvc shared-pvc
kubectl logs backend-76b9697f85-n8tpr
kubectl run backend-debug --rm -it --image=shehzadkhuwaja/todoapp:latest -- sh
kubectl run -it --rm --restart=Never --image postgres psql-for-debugging sh
kubectl describe statefulset postgres-statefulset -n exercises
kubectl rollout restart deployment ping-pong-dep -n exercises
kubectl port-forward svc/grafana 32000:80 -n monitoring

-- debugging jobs
kubectl get pods -n project --selector=job-name=wikipedia-todo-generator-2898d
kubectl get jobs -n project


-- To push your docker image to docker hub --
docker tag express-server:local yourusername/express-server:latest
docker push shehzadkhuwaja/express-server:latest

-- Commands for encryption and decryption
age-keygen -o key.txt
sops --encrypt \
       --age age17mgq9ygh23q0cr00mjn0dfn8msak0apdy0ymjv5k50qzy75zmfkqzjdam4 \
       --encrypted-regex '^(data)$' \
       secret.yaml > secret.enc.yaml
export SOPS_AGE_KEY_FILE=$(pwd)/key.txt
sops --decrypt secret.enc.yaml > secret.yaml
sops --decrypt secret.enc.yaml | kubectl apply -f -


-- Testing db connection
kubectl run -it --rm --restart=Never --image postgres psql-for-debugging sh
  $ psql postgres://yourpostgresurlhere
  psql (16.2 (Debian 16.2-1.pgdg120+2))
  Type "help" for help.
  postgres=# \d
  Did not find any relations.

-- Monitoring Kubernetes cluster
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm install loki grafana/loki-simple-scalable -n monitoring --create-namespace
helm install promtail grafana/promtail -f promtail-values.yaml -n monitoring
helm install grafana grafana/grafana -f grafana-values.yaml -n monitoring
kubectl get secret grafana -n monitoring -o jsonpath="{.data.admin-password}" | base64 --decode
helm upgrade grafana grafana/grafana -f grafana-values.yaml -n monitoring
helm upgrade loki grafana/loki-simple-scalable -f loki-values.yaml -n monitoring


-- 
$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
$ helm repo add stable https://charts.helm.sh/stable
$ helm repo update
$ kubectl create namespace prometheus
$ helm install prometheus-community/kube-prometheus-stack --generate-name --namespace prometheus
kubectl get po -n prometheus
kubectl -n prometheus port-forward kube-prometheus-stack-1602180058-grafana-59cd48d794-4459m 3000
$ helm repo add grafana https://grafana.github.io/helm-charts
$ helm repo update
$ kubectl create namespace loki-stack
  namespace/loki-stack created

$ helm upgrade --install loki --namespace=loki-stack grafana/loki-stack --set loki.image.tag=2.9.3

helm upgrade --install loki grafana/loki-simple-scalable \
  -n monitoring \
  --set ingester.replicas=1 \
  --set ingester.minReady=1 \
  --set ingester.heartbeatPeriod=5s

-- Google cloud commands --
gcloud container clusters list
gcloud projects list
gcloud config set project dwk-gke-idhere
gcloud services enable container.googleapis.com
gcloud auth login
gcloud container clusters create dwk-cluster --zone=europe-north1-b --cluster-version=1.32 --disk-size=32 --num-nodes=3 --machine-type=e2-micro
gcloud container clusters get-credentials CLUSTER_NAME \
    --location=CONTROL_PLANE_LOCATION
gcloud container clusters delete CLUSTER_NAME --zone ZONE
gcloud container clusters delete pingpong-cluster --zone=europe-north1-b
gcloud container operations cancel <OPERATION_NAME> --zone=europe-north1-b

Billing Details
gcloud beta billing projects describe 145104890783
gcloud beta billing accounts list
gcloud beta billing projects link 145104890783 \
  --billing-account=XXXXXX-XXXXXX-XXXXXX


How to access postgres
kubectl exec -it postgres-statefulset-0 -n exercises -c postgres-db -- bash
psql -U $POSTGRES_USER -d $

Enabling gateway API
Note: when using gateway api the service type should be cluster IP whereas for ingress it has to be nodeport
gcloud container clusters update clustername --location=europe-north1-b --gateway-api=standard

Applying Kustomization
kubectl apply -k .

-- Command to generate key for google service account
gcloud iam service-accounts keys create ./private-key.json --iam-account=github-actions@dwk-gke-331210.iam.gserviceaccount.com

Command to delete a branch
git push origin --delete branch_name

-- Commands to create Bucket, give service account permissions, and generating key
gcloud iam service-accounts create gcs-backup-sa --description="SA for u
ploading DB backups to GCS" --display-name="GCS Backup SA"     

gcloud storage buckets add-iam-policy-binding gs://todo-db-backups \
  --member="serviceAccount:gcs-backup-sa@<PROJECT_ID>.iam.gserviceaccount.com" \
  --role="roles/storage.objectAdmin"

gcloud iam service-accounts keys create key.json \
  --iam-account=gcs-backup-sa@<PROJECT_ID>.iam.gserviceaccount.com

kubectl create secret generic gcs-backup-key \
  --from-file=key.json

Force deleting a container inside a Kubernetes
kubectl delete pod <pod-name> --namespace <namespace> --grace-period=0 --force


--- To observe the behaviour of pods and deployment in real time ---
kubectl get deployments --watch
kubectl get pods --watch

-- To autoscale nodes
$ gcloud container clusters update dwk-cluster --zone=europe-north1-b --enable-autoscaling --min-nodes=1 --max-nodes=5


-- Command to understand top utilization of resources by pods
Kubectl top pods

-- How to enable logging and monitoring in cluster
gcloud container clusters update my-cluster --zone us-central1-a --enable-stackdriver-kubernetes

-- HOW to rollback to previous deployment
kubectl describe deployment flaky-update-dep | grep Image
kubectl rollout undo deployment flaky-update-dep --to-revision=1
kubectl rollout undo --help

-- How to debug argo rollout
kubectl get analysisruns -n exercises
kubectl describe analysisrun <analysisrun-name>

kubectl edit rollout ping-pong-rollout -n exercises

-- Commands to setup NATS
auth:
  enabled: false
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: prometheus
helm upgrade -f myvalues.yaml my-nats oci://registry-1.docker.io/bitnamicharts/nats

 kubectl exec --tty -i my-nats-client --namespace nats -- bash
    nats -s nats://my-nats.nats.svc.cluster.local:4222  subscribe SomeSubject
    nats -s nats://my-nats.nats.svc.cluster.local:4222  publish SomeSubject "Some message"

 echo "Monitoring URL: http://127.0.0.1:8222"
    kubectl port-forward --namespace nats svc/my-nats 8222:8222

-- useful helm command
 helm uninstall my-nats -n nats


-- Commands to setup ArgoCD --
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}' (beaware of how powershell handles json)
or
kubectl edit svc argocd-server -n argocd 
kubectl get svc -n argocd
kubectl get -n argocd secrets argocd-initial-admin-secret -o yaml
