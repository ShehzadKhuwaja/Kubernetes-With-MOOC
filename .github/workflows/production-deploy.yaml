name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CONFIG_REPO: ShehzadKhuwaja/Kubernetes-With-MOOC-config

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout code repository
        uses: actions/checkout@v4
      
      - name: Extract tag and commit SHA
        id: vars
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name:  Checkout config repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONFIG_REPO }}
          token: ${{ secrets.CONFIG_REPO_TOKEN }}
          path: config-repo
      
      - name: Update production kustomization with all images
        working-directory: config-repo
        run: |
          cd overlays/production
          
          # Update all images with the commit SHA from the tagged release
          kustomize edit set image \
            shehzadkhuwaja/broadcaster:${{ steps.vars.outputs.sha_short }} \
            shehzadkhuwaja/frontend:${{ steps.vars.outputs.sha_short }} \
            shehzadkhuwaja/backend-imageapi:${{ steps.vars.outputs.sha_short }} \
            shehzadkhuwaja/backend-todos:${{ steps.vars.outputs.sha_short }} \
            shehzadkhuwaja/wikipedia-todo-generator:${{ steps.vars.outputs.sha_short }}
      
      - name: Commit and push changes to config repo
        working-directory: config-repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add overlays/production/kustomization.yaml
          git commit -m "Deploy ${{ steps.vars.outputs.tag }} to production (commit:  ${{ steps.vars.outputs.sha_short }})"
          git push